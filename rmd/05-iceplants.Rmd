\newpage

# Chapter 4: Climate constrains the current distribution of a highly invasive succulent 

Sam C. Levin $^{\ast1,2,3}$, Roberto Salguero-Gómez $^{3\ddagger}$, Tiffany M. Knight $^{1,2,4\ddagger}$

$^1$Institute of Biology, Martin Luther University Halle-Wittenberg, Am Kirchtor 1, 06108 Halle (Saale), Germany

$^2$German Centre for Integrative Biodiversity Research (iDiv) Halle-Jena-Leipzig, Deutscher Platz 5e, 04103 Leipzig, Germany

$^3$Department of Zoology, 11a Mansfield Rd, University of Oxford, Oxford, OX1 3SZ, UK

$^4$Department of Community Ecology, Helmholtz Centre for Environmental Research-UFZ, Theodor-Lieser-Straße 4, 06120, Halle (Saale), Germany

$^\ddagger$ Joint senior authors


### Abstract

```{r echo = FALSE, message = FALSE, warning = FALSE, eval = TRUE}

# Remove this block to compile complete dissertation.
library(dplyr)
library(tidyr)
library(tools)
library(kableExtra)
library(brms)
library(ggplot2)
library(randomForest)
library(patchwork)
library(forcats)

```


```{r echo = FALSE, warning = FALSE, message = FALSE}

rams <- readRDS("../Data/all_ramets_di.rds")
t_2_out <- read.csv("../Data/t_2_omissions.csv",
                    stringsAsFactors = FALSE) %>%
  setNames(c("site", "id"))

rams_t_2 <- anti_join(rams, t_2_out, by = c("site", "id"))

grow_mod <- readRDS("../Data/ramet_growth_list_krig.rds")[[1]][["times_sw3_seas"]]
grow_dat <- grow_mod$data

surv_mod <- readRDS("../Data/ramet_survival_list_krig.rds")[[1]][["times_sw3_seas"]]
surv_dat <- surv_mod$data

repr_mod <- readRDS("../Data/ramet_repro_list_krig.rds")[[1]][["times_sw1_seas"]]
repr_dat <- repr_mod$data

flow_mod <- readRDS("../Data/ramet_flower_n_list_lin_slope_ran.rds")[[1]][["times_sw3_seas"]]
flow_dat <- flow_mod$data

rf <- readRDS("../Data/all_site_rf_ltre_with_site_term.rds")
clim <- read.csv("../Data/site_climate_values.csv")
lams <- read.csv("../Data/lin_mod_general_ipm_site_lambdas_prob_resamp.csv")


```

### Introduction

Invasive species are ecological and economic pest at local, regional, and global scales (Pimentel et al. 2005, Vila et al. 2011, Levin et al. 2020). There is an extensive body of work devoted to understanding how invasive species become invasive to begin with (reviewed in Lowry et al. 2013 and Jeschke & Heger 2018). However, generalization across families, genera, and even species remains difficult as environmental contexts can vary greatly across the invaded range, and population level processes (e.g. founder effects, rapid evolution, or hybridization) can induce rapid change in the invading population (XXXX). The former is receiving increasing attention, as there is growing recognition that climate change may interact with these invasions to produce an even greater threat to ecosystems.

Climate change poses an additional challenge for conservation practitioners, both in its own right by altering environmental contexts for endangered species (XXXX) and by facilitating new invasions (XXXX). There is a growing body of literature illustrating the importance of the interaction between climate change and invasions. However, results are appear idiosyncratic beyond the most general of conclusions (e.g. climate change exacerbates some invasions, hinders others). As a result, there are still large gaps in our knowledge with respect to threatened types of biomes, their invaders, and the the impacts said invaders may have in the both the short- and long-term futures. 

Mediterranean biomes are threatened by both climate change (XXXX) and invasions (XXXX). They are home to vast array of endemic plant and animal species, with some nature reserves in Western Cape, South Africa containing more species than the entirety of the UK (XXXX). Outside of South Africa, they are threatened by the _Carpobrotus_ genus (Aizoaceae), particularly _C. edulis_, _C. acinaciformis_, _C. chilensis_, and their hybrids. These species are spreading, mat forming succulents, and are exceptionally competitive for water and light (D'Antonio 199X, Novoa et al. 2012, Campoy et al. 2018). There is a growing body of evidence indicating these species are allelopathic, with their dessicated litter acidifying the soil and preventing other species from germinating (Novoa et al. 2012, Novoa et al. 2014).

Given the joint issues posed by climate change and invasions, there have been recent efforts aimed at understanding how they might interact. Species distribution models (SDMs) are often applied to this problem, as they make use of readily available occurrence data to estimate species' ranges as a function of environmental covariates (Guisan & Thullier 2005). However, SDMs have also been criticized for certain applications, as they are often unable to predict occurrences in environments that fall outside the climate envelope of the observed range (reviewed in Liu et al. 2020). Classical SDMs make use of presence data or presence-absence data for a species, and do not necessarily include information on spatial variation in population performance. One exception to this is the demographic distribution model, which link the environment to species performance and dispersal, and then project future occupancies based on these relationships (Merow et al. 2014, Garcia-Callejas et al. 2017). 

In the context of invasions, there are issues that can arise with the SDM approach. Making predictions on invaded range occupancy and performance based solely on data from the native range is risky because of novel biotic interactions that may arise, and because this practice often involves extrapolating estimates beyond the observed range of environmental data (Broennimann & Guisan 2008). Furthermore, the assumption that species are at equilibrium with their environment and thus occupy all suitable areas is unlikely to be true when using data from the invaded range (Elith et al. 2010). One approach to handling these issues is to incorporate data from both the native and invaded range, and sample broadly across environmental gradients (Merow et al. 2014, Briscoe et al. 2019). In the context of invasions, this may require sampling across multiple continents and combining data from multiple sources, which can be onerous both technically and fiscally. However, new methods of rapidly collecting demographic data, such as unmanned aerial vehicles (UAVs, drones) are reducing both of these burdens.

Here, we apply novel demographic sampling methods to the _Carpobrotus_ genus across `r length(unique(rams$site))` sites spread throughout their native and invaded range. We expect that, given _Carpobrotus_'s ability to compete for water and the fact that Mediterranean ecoregions are generally drier than other ecoregions, sites that receive less precipitation will show higher per-capita growth rates than sites receiving more precipitation (i.e. we assume water is the primary limiting resource across our sites). We use a combination of Integral Projection Models (IPMs), generalized additive models (GAMs), and a life table response experiment (LTRE) to test these hypotheses. We show that the _Carpobrotus_ genus is most affected by precipitation in both the wet and dry season.

### Methods

This study was conducted across `r length(unique(rams$site))` sites spread across South Africa (native range), New Zealand (invaded), Portugal (invaded), and Israel (invaded, Figure 4.1). Sites in the Northern Hemisphere were sampled in March/April, and sites in the Southern Hemisphere were sampled in September/October each year so that plants were observed during their peak flowering period (i.e. early spring). Each site was selected based on degree of invasion, and the ability to sample without disturbing local flora and fauna (Table 4.1). 

We used drones to collect aerial imagery each population. The following methods are general - site specific modifications to this protocol are described in Table 1 and the ESM. We developed flight plans to map each population using DJI Ground Station Pro v2 (henceforth called "GSP", SZ DJI Technology Co.) for iPad (Apple Inc). We used the app to draw polygons over an area of interest, and then let the app compute the optimal flight path given our desired resolution. We selected a flight path that generated a resolution of 0.2 - 0.45 cm/pixel. This resulted in a range of 70-85% side  and front photo overlap. The average width of open flowers is 7.46 cm (+/- 0.008 S.E.) and unripe fruits was 2.32 cm (+/- 0.002 S.E.) across all populations (SC Levin, unpublished data), so this resolution is sufficient to allow us to mark the majority of both in the resulting maps (orthomosaics, see below for more details). Transects were flown with a DJI Phantom 4 Pro v1 (SZ DJI Technology Co.) along the lines of the flight plan generated by DJI GSP and images were recorded at 1.8 - 2m intervals. When batteries reached a critical level of power (i.e. ~20%), we landed the drone, switched the batteries out, and the flight was resumed from the last stopping point. 

Once all images were captured after the first aerial survey, individual photos were processed into a single composite, georeferenced orthomosaic map using Pix4Dmapper (Pix4D SA, 2019). We drew individual polygons around contiguous *Carpobrotus* ramets, assigned each a unique ID number, and counted flowers using a point layer in QGIS (QGIS Development Team 2021). We repeated the process in 2019 by overlaying the 2019 map on the 2018 map and marking polygons for all surviving individuals as well as new recruits also in QGIS. The surveys sometimes did not perfectly overlap with each other, so ramets from the first survey that were not flown over again were excluded from all analyses. Individual ramets that were not found again in our second aerial survey were assumed dead. Maps were aligned between the first and second surveys using the Georeferencer GDAL plugin (QGIS Development Team 2021) in QGIS because the georeferencing of the orthomosaics was only accurate to ~5m. This plugin allows users to manually find and mark common points on both images and set them as reference points for transformation between the old coordinate system (map coordinates of survey 2) and the new coordinate system (map coordinates of survey 1). We used the thin plate splines transformation for the coordinate systems and nearest neighbor resampling method. The reference points are available in the supplementary materials. In addition to drawing polygons around the individual plants, we drew polygons around targets of known sizes and computed the ratio of calculated areas under the polygon vs the known sizes. We then re-scaled all computed sizes of plants using this ratio. Once all sizes, flowering information, and survival data were digitized, we used the `sf` (Pebesma 2018) and `dplyr` (Wickham et al. 2022) _R_ packages to join all the ramet data into a single dataset. In some cases, the second drone flight could not cover the entire extent of the first one (e.g. due to new construction of power lines). Ramets that could not be re-sampled were included in the probability of flowering and number of flowers produced regression models, but omitted from survival and growth analyses (see below for details).

```{r echo = FALSE, message = FALSE}

ipm_sites <- c("Struisbaai", "St_Francis", "Melkboss", "Vogelgat",
               "Rooisand", "Springfontein", "Rough_Island",
               "Rarangi", "Foxton", "Whirinaki", "Havatselet",
               "Praia_de_Areao", "Colares")

sites <- read.csv("../Data/drone_flight_metadata.csv",
                  stringsAsFactors = FALSE) %>%
  filter(population %in% ipm_sites)


sites <- rams %>%
  group_by(site) %>%
  summarise(N_ramets = n()) %>%
  right_join(sites, by = c("site" = "population")) %>%
  select(site, lat, lon, date_flight_1, date_flight_2, N_ramets) 

sites$population <- gsub("_", " ", sites$population)

names(sites) <- gsub("_", " ", names(sites))

names(sites) <- toTitleCase(names(sites))

cap <- "Table 4.1: Population locations, sample dates, and sizes."

kable(sites,
       format = "html",
      # col.names = c("Concept", "Column Name", "Description"),
      caption = cap) %>%
  column_spec(1, border_left = TRUE) %>%
  column_spec(6, border_right = TRUE)

```

```{r echo = FALSE, message = FALSE, warning = FALSE, fig.cap = "**Figure 4.1**:  Geographic distribution of ll sites used for climate envelope calculations (in black) and all sites used for demographic modeling (in red). Insets show locations within each region."}


wrld <- st_read("../Data/World_Continents/continents.shp", quiet = TRUE) 

all_clim_sites <- read.csv("../Data/all_gbif_field_sites.csv",
                           stringsAsFactors = FALSE)  %>%
  filter(site %in% ipm_sites | is.na(site)) %>%
  mutate(sampled_for_demography = case_when(
    site %in% ipm_sites ~ "Yes",
    TRUE ~ "No"
  ))

sa <- filter(all_clim_sites, site %in% ipm_sites[1:6])
nz <- filter(all_clim_sites, site %in% ipm_sites[7:10])
med <- filter(all_clim_sites, site %in% ipm_sites[11:13])

med_map <- ggplot(wrld,
                  aes(group = CONTINENT)) +
  geom_sf(color = "grey50",
          fill = "antiquewhite") +
  coord_sf(xlim = c(-12, 36),
           ylim = c(30, 42)) +
  geom_point(data = med, 
             aes(x = lon, y = lat), 
             color = "red",
             inherit.aes = FALSE) +
  theme(panel.background = element_rect(fill = "aliceblue"),
        axis.title = element_blank(),
        plot.margin = unit(c(0, 0, 0, 0), "mm"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank(),
        axis.ticks.length = unit(0, "pt")) +
  annotate("text", x = 2, y = 32, size = 4, label = "EU/Israel")

sa_map <- ggplot(wrld,
                  aes(group = CONTINENT)) +
  geom_sf(color = "grey50",
          fill = "antiquewhite") +
  coord_sf(xlim = c(18, 25),
           ylim = c(-38, -33)) +
  geom_point(data = sa, 
             aes(x = lon, y = lat), 
             color = "red",
             inherit.aes = FALSE) +
  theme(panel.background = element_rect(fill = "aliceblue"),
        axis.title = element_blank(),
        plot.margin = unit(c(0, 0, 0, 0), "mm"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank(),
        axis.ticks.length = unit(0, "pt")) +
  annotate("text", x = 22, y = -35.5, size = 4, label = "South Africa")

nz_map <- ggplot(wrld,
                  aes(group = CONTINENT)) +
  geom_sf(color = "grey50",
          fill = "antiquewhite") +
  coord_sf(xlim = c(165, 180),
           ylim = c(-45, -36)) +
  geom_point(data = nz, 
             aes(x = lon, y = lat), 
             color = "red",
             inherit.aes = FALSE) +
  theme(panel.background = element_rect(fill = "aliceblue"),
        axis.title = element_blank(),
        plot.margin = unit(c(0, 0, 0, 0), "mm"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank(),
        axis.ticks.length = unit(0, "pt")) +
  annotate("text", x = 172, y = -43, size = 3.5, label = "New Zealand")

world_map <- ggplot(wrld,
                   aes(group = CONTINENT)) +
  geom_sf(color = "grey50",
          fill = "antiquewhite") + 
  coord_sf(xlim = c(-180, 180),
           ylim = c(-60, 60), expand = FALSE) +
  geom_point(data = all_clim_sites, 
             aes(x = lon, y = lat,
                 color = sampled_for_demography,
                 alpha = sampled_for_demography,
                 size  = sampled_for_demography), 
             inherit.aes = FALSE) +
  xlab("") +
  ylab("") +
  scale_color_manual(values = c("red", "black"),
                     breaks = c("Yes", "No")) +
  scale_size_manual(values = c(2, 1.25),
                    breaks = c("Yes", "No")) +
  scale_alpha_manual(values = c(0.7, 0.3),
                     breaks = c("Yes", "No")) +
  guides(size  = guide_legend("Sampled For Demography"),
         color = guide_legend("Sampled For Demography"),
         alpha = guide_legend("Sampled For Demography")) +
  theme(legend.position = "top",
        legend.direction = "horizontal",
        panel.background = element_rect(fill = "aliceblue"),
        plot.margin = unit(c(0, 0, 0, 0), "mm"),
        axis.text = element_blank(),
        axis.ticks = element_blank()) 

world_map + 
  inset_element(med_map, 
                left = 0,
                top = 0, 
                bottom = -0.3, 
                right = 0.25)  + 
  inset_element(sa_map, 
                left = 0.375,
                top = 0, 
                bottom = -0.35, 
                right = 0.625) +
  inset_element(nz_map, 
                left = 0.75,
                top = 0,
                bottom = -0.4, 
                right = 1)

```

The primary goal of this study was to understand how environmental variation constrains or facilitates invasion by _Carpobrotus_ species. Therefore, we compiled a data set of georeferenced _Carpobrotus_ records from across the globe from GBIF, and cleaned them with the `CoordinateCleaner` _R_ package (Zizka et al. 2019, Figure 4.1). We downloaded monthly ERA5 climate data from 2018 - 2020 for temperature ($\theta_t$), precipitation ($\theta_p$), and soil water content ($\theta_{s,i}$ where $i$ is the soil layer with values 1-3. See Appendix for more details). Data were kriged for each occurrence point, plus our site coordinates using the `krigR` _R_ package (Kusch & Davy, 2022). We aggregated data by wet and dry season (i.e. $\theta_s$ values for the wet season, and $\theta_s$ values for the dry season). Finally, we computed how many standard deviations each of our sites was from the global mean value of each environmental covariate to create a standardized environmental value for each site in our data set (Compagnoni et al. 2021).  

We modeled size-dependent survival (Bernoulli model with logit link, $s_a(z, \theta)$), size  at time $t + 1$ ($z'$) conditional on survival and size at time $t$ (Gaussian model with identity link and size dependent variance, $G(z'|z, \mu_g, \sigma_g, \theta)$), size-dependent probability of flowering (Bernoulli model with logit link, $p_f(z, \theta)$), and size-dependent flower production (negative binomial model with log link, $r_f(z, \theta)$). In addition to size, we included environmental covariates ($\theta$, described in previous paragraph). We constructed Bayesian generalized linear mixed models (GLMMs) and compared different structures using WAIC, posterior predictive checks, and visual inspection of predictions against the observed data. We selected the best models chosen by WAIC that also made realistic predictions as determined by the latter graphical checks. Each of the potential forms used $\theta_t, \theta_p$ and one of the $\theta_{s,i}$ values as predictors, and interactions between size and environmental covariates were tested as well (included in the GAMMs as tensor product interactions). Because the responses of $p_f(z, \theta)$ and $r_f(z, \theta)$ are based on state at time $t$, we included environmental covariates from the year before the initial demographic sampling (i.e. $t-1$ to $t$), whereas $s_a(z, \theta)$ and $G(z'|z, \sigma, \theta)$ to $t+1$ used environmental data from the year between demographic samples. All candidate models included a population-specific intercept term and interaction between size and nativity. All vital rate models were implemented with the `brms` _R_ package (Bürkner et al. 2018).

In addition to the vital rates above, we also modeled the size of new recruits at time $t + 1$ ($r_a(z')$), and estimated probabilities for flower pod survival ($p_{fv}$) and maturation ($p_m$) to time $t+1$, immediate seed germination ($g_i$), total viability ($v_s$), and seed establishment probability ($p_e$), and seed bank germination ($g_{sb}$) and survival ($s_{sb}$).  Data for $r_a(z')$ was collected from the Rooisand site in South Africa. In 2018, we delineated 2 $40 cm \times 40 cm$ plots and counted the number of seedlings. In 2019, we returned and flew brief surveys with the drone at ~ 1.2m above ground level. We generated orthomosaics using the same procedure described above, and then counted surviving seedlings and drew polygons around them to estimate their size. Unfortunately, we did not find seedlings in sufficient quantities at other sites to establish plots, and so our sample size is limited to these two plots at a single site for these parameters. We conducted literature reviews to gather estimates of other seed-related parameters, and these were estimated by averaging over the reported estimates (Table 4.2). For two vital rates ($p_e$ and $s_{sb}$), we could not find values in the literature. Therefore, we conducted simulations to examine a reasonable range of values ($1^{-5} - 1^{-4}$ and $1^{-2} - 1^{-1}$, respectively) to examine how our results changed as a function of these values. Our conclusions are not sensitive to these values, and these results are reported in Appendix 1 (Chapter 14).

We used the parameters and functions described above to generate an Integral Projection Model (IPM) for each site.  Our IPM included 1 continuous trait, size ($z, z'$), and 3 discrete states - mature fruits ($mf$), seedlings ($sdl$), and seeds in the seed bank ($sb$) (see Appendix 7 for complete equations and parameter distributions describing the IPM). We combined the vital rate functions described above into an IPM in _R_ using the `ipmr` package (Levin et al. 2021). Point estimates of the deterministic per-capita growth rate for each site, $\lambda_i$ were computed from IPMs parameterized with mean values of the posterior distribution for each parameter estimated in the Bayesian regression models described above. We then used the posterior distributions for each regression model to create 4000 $\lambda_i$ values representing a range of plausible IPMs for each site. 

Our goal was to determine both the shape and magnitude of a climate driver's effect on $\lambda$ _and_  the relative importance of each driver for _Carpobrotus_'s fitness at a global scale. To address the first goal, we constructed GAMs with the estimated $\lambda$ values as the response and each climate driver as a predictor. GAMs are well suited to this because population responses to a climate driver may be non-linear across the range of sampling. To address the second goal, we conducted an Life Table Response Experiment (LTRE) with $\lambda$ as the response and the spatially varying IPM parameters as predictors (Caswell 2001, Ellner, Childs & Rees 2016). Specifically, we used a random forest to estimate the relationship between the posterior draws for $\lambda$ and the IPM regression parameters. Random forests are well suited for this analysis because they are non-parametric, non-linear models that can handle high dimensional data (Breiman 2001). We assessed the importance of each variable by randomizing parameter values and computing the change in mean squared error (MSE) of the of the overall regression tree. Larger increases in MSE for a given parameter value indicate that it is more important in predicting $\lambda$, and therefore contributing more to the observed value of $\lambda$ (Ellner, Childs & Rees 2016). We implemented all of the LTRE analyses using the `randomForest` _R_ package (Liaw & Weiner 2002).

### Results

We successfully sampled `r nrow(repr_dat)` ramets for probability of flowering ($p_f(z, \theta)$), `r nrow(flow_dat)` ramets for number of flowers produced ($r_f(z, \theta)$), `r nrow(surv_dat)` ramets for survival ($s_a(z, \theta)$), and `r nrow(grow_dat)` ramets for growth ($G(z' | z, \sigma, \theta)$). Model selection and diagnostic plots for all vital rates indicated GLMM fits were best. We used a number of sources for each discrete parameter estimate (Appendix Table 14.2). 

IPMs yielded $\lambda$ values between 0.6 and 1.3 for every population we sampled. GAMs for $lambda_i$ as a function of each climate variable show differing responses, but climate parameters were generally of low importance in predicting $\lambda$ values, indicating a weak relationship between climate and population performance (Figure 4.2). However, dry seasons precipitation showed a consistently negative effect on $\lambda_i$.

```{r echo = FALSE, warning = FALSE, fig.cap = "**Figure 4.2**: Relationship between $\lambda$ and the climate variables included in the IPMs. Black dashed lines represent the fit from the GAMs of `lambda ~ <climate_variable>`, and red dotted lines indicate $\lambda = 1$, meaning the population is stable.", fig.height = 8, fig.width = 10}

all_lams <- lams %>%
  pivot_longer(cols = -c(obs),
               names_to = "site",
               values_to = "lambda") %>%
  mutate(site = gsub("lambda_", "", site))

clim_vars <- expand.grid(c("temp", "prec", "sw1", "sw3"), c("dry", "wet"), c("t", "t_1")) %>%
  apply(1, function(x) paste(x, collapse = "_")) %>% 
  c("site") %>%
  syms()


all_clim <- clim %>%
  select(!!! clim_vars) %>%
  pivot_longer(-site,
               names_to = "clim_var", 
               values_to = "clim_val")

all_data <- all_lams %>%
  group_by(site) %>%
  summarise(obs_val  = first(lambda[obs == "yes"]),
            up_ci    = quantile(lambda[obs == "no"], 0.95),
            lo_ci    = quantile(lambda[obs == "no"], 0.05)) %>%
  left_join(all_clim) %>%
  mutate(native = case_when(
    site %in% c("Struisbaai", "Rooisand",
                "Vogelgat", "Springfontein",
                "Melkboss", "St_Francis") ~ "Native",
    TRUE ~ "Invasive"
  ))

use_clim_vars <- expand.grid(clim = c("prec_dry", "temp_dry", "prec_wet"),
                             t    = c("t", "t_1")) %>%
  apply(1, FUN = function(x) paste0(x, collapse = "_"))

plt_dat <- filter(all_data, clim_var %in% use_clim_vars) %>%
  mutate(clim_var = case_when(
    clim_var == "temp_dry_t" ~ "Dry season temperature (t)",
    clim_var == "prec_dry_t" ~ "Dry season precipitation (t)",
    clim_var == "prec_wet_t" ~ "Wet seasons precipitation (t)",
    clim_var == "temp_dry_t_1" ~ "Dry season temperature (t + 1)",
    clim_var == "prec_dry_t_1" ~ "Dry season precipitation (t + 1)",
    clim_var == "prec_wet_t_1" ~ "Wet seasons precipitation (t + 1)"
  ), 
  clim_var = fct_relevel(as.factor(clim_var),
                         c("Dry season temperature (t)",
                           "Dry season precipitation (t)",
                           "Wet seasons precipitation (t)",
                           "Dry season temperature (t + 1)",
                           "Dry season precipitation (t + 1)",
                           "Wet seasons precipitation (t + 1)"
                           )))

ggplot(plt_dat,
              aes(x = clim_val, y = obs_val, color = site, shape = native)) +
  geom_hline(yintercept = 1, color = "firebrick", linetype = "dotted", 
             size = 1.2) + 
  geom_point(size = 5, alpha = 0.5) +
  geom_linerange(aes(ymin = lo_ci, ymax = up_ci), size = 1.2, alpha = 0.5) +
  geom_smooth(aes(x = clim_val, y = obs_val),
              inherit.aes = FALSE,
              method = "gam",
              formula = y ~ s(x, k = 5),
              color = "black",
              linetype = "dashed") +
  theme_bw() +
  facet_wrap(~ clim_var, scales = "free_x") +
  xlab("Climate Value (SD from global mean)") +
  ylab(expression(lambda))


```

The random forest LTRE explained `r round(rf$rsq[751], 2) * 100`% of the variance in $\lambda$ across sites. Decomposing the contributions of each parameter showed that site specific random effects were the most important parameters in the model. Climate related vital rate parameters were of substantially lesser importance, but many were included in the top 20 most important parameters in the IPMs (Figure 4.3).


```{r echo = FALSE, warning = FALSE, fig.cap = "**Figure 4.3**: Variable importance as determined by the random forest. .", fig.height = 8, fig.width = 10}


imps <- rf$importance %>%
  as.data.frame() %>%
  mutate(var = rownames(.)) %>%
  select(c(1, 3))%>% 
  cbind(imp_sd = rf$importanceSD) %>%
  setNames(c("inc_mse", "var", "imp_sd")) %>%
  filter(!grepl("sw[0-9]", var)) %>%
  arrange(desc(inc_mse)) %>%
  mutate(var = gsub("flow", "Flower #", var),
         var = gsub("repr", "Pr(flowering)", var),
         var = gsub("grow", "Growth", var),
         var = gsub("surv", "Survival", var),
         var = gsub("slope_ran", "Random Slope", var),
         var = gsub("intercept_ran", "Random Intercept", var),
         var = gsub("temp", "Temperature", var),
         var = gsub("x", "X", var),
         var = gsub("int", "Fixed Intercept", var),
         var = gsub("prec", "Precipitation", var),
         var = gsub("log_size", "Size", var),
         var = gsub("__", "_", var),
         var = gsub("_", " ", var),
         var = gsub("wet", "Wet", var),
         var = gsub("dry", "Dry", var),
         var = gsub("sigma", "Sigma", var),
         var = gsub("native", "Nativity", var)) %>%
  mutate(var = factor(var, levels = as.character(var)),
         var = fct_reorder(var, inc_mse, .fun = max))


ggplot(filter(imps, var != "site")[1:20, ], 
                            aes(x = var, y = inc_mse)) + 
  geom_point(size = 2) + 
  geom_linerange(aes(ymin = pmax(0, inc_mse - 2 * imp_sd), ymax = inc_mse + 2 * imp_sd),
                 size = 1.2) +
  coord_flip() +
  theme_bw() +
  ylab("Importance") +
  xlab("Vital Rate Regression Parameter")



```

### Discussion



### Citations

2. Bürkner, P.-C. (2018). Advanced Bayesian Multilevel Modeling with the R Package brms. The R Journal, 10(1), 395-411. doi:10.32614/RJ-2018-017

3. Liaw, A. & Wiener, M. (2002). Classification and Regression by randomForest. R News 2(3), 18--22.

6. Breiman, L. (2001). Random Forests. Machine Learning 45: 5-32. DOI: https://doi.org/10.1023/A:1010933404324

1. Pebesma, E., 2018. Simple Features for R: Standardized Support for Spatial Vector Data. The R Journal 10 (1), 439-446, https://doi.org/10.32614/RJ-2018-009

3. Wickham, H., François, R.,  Henry, L., & Müller, K. (2021). dplyr: A Grammar of Data
  Manipulation. R package version 1.0.7. https://CRAN.R-project.org/package=dplyr

2. Zizka, A., Silvestro, D., Andermann, T., Azevedo, J., Duarte Ritter, C., Edler, D., _et al._ (2019). “CoordinateCleaner: standardized cleaning of occurrence records from biological collection databases.” Methods in Ecology and Evolution 10. DOI: 10.1111/2041-210X.13152 (URL: https://doi.org/10.1111/2041-210X.13152), R package version 2.0-20

